CREATE DATABASE COCHES1;
USE COCHES1;
CREATE TABLE COCHES(
MAT VARCHAR (5),
MARCA VARCHAR (15),
AN_FAB VARCHAR (2),
CONSTRAINT COCHES PRIMARY KEY (MAT)
)ENGINE = INNODB;

CREATE TABLE MECANICOS(
DNI VARCHAR (9),
NOMBRE VARCHAR (15),
PUESTO VARCHAR (15),
PARCIAL VARCHAR (1),
CONSTRAINT MECANICOS primary key (DNI)
) ENGINE = INNODB;

CREATE TABLE TRABAJOS(
COD_TRABAJO VARCHAR (4),
MAT VARCHAR (5),
DNI VARCHAR (9),
HORAS tinyint (10),
fecha_rep date,
CONSTRAINT  PRIMARY KEY (COD_TRABAJO),
CONSTRAINT FOREIGN KEY (MAT) REFERENCES COCHES(MAT),
CONSTRAINT FOREIGN KEY (DNI) REFERENCES MECANICOS(DNI)
) ENGINE= INNODB;

ALTER TABLE COCHES ADD COLUMN MODELO VARCHAR (15);

ALTER TABLE COCHES MODIFY COLUMN MAT VARCHAR (7);
ALTER TABLE COCHES MODIFY COLUMN AN_FAB VARCHAR (4);
ALTER TABLE TRABAJOS MODIFY COLUMN MAT VARCHAR (7);

INSERT INTO coches (mat, marca, modelo, AN_FAB) VALUES ('M3020KY', 'TOYOTA', 'CARINA', 2016);
INSERT INTO coches (mat, marca, modelo, AN_FAB) VALUES ('A3020KA', 'RENAULT', 'MEGANE ', 2017);
INSERT INTO coches (mat, marca, modelo, AN_FAB) VALUES ('B3020KB', 'RENAULT ', '5', 2017);
INSERT INTO coches (mat, marca, modelo, AN_FAB) VALUES ('C3020KC', 'PEUGEOT ', '504', 2018);
INSERT INTO coches (mat, marca, modelo, AN_FAB) VALUES ('D3020KD', 'PEUGEOT ', '504', 2018);
INSERT INTO coches (mat, marca, modelo, AN_FAB) VALUES ('E3020KE', 'BEATTLE ', '207', 2019);
INSERT INTO coches (mat, marca, modelo, AN_FAB) VALUES ('H3020KH', 'TOYOTA', 'CARINA', 2016);
INSERT INTO coches (mat, marca, modelo, AN_FAB) VALUES ('H3020KH', 'TOYOTA', 'CARINA', 2016);

INSERT INTO MECANICOS (DNI, NOMBRE, PUESTO, PARCIAL) VALUES ('1111', 'ANTONIO', 'MOTOR', '1');
INSERT INTO MECANICOS (DNI, NOMBRE, PUESTO, PARCIAL) VALUES ('2222 ', 'LUIS', 'MOTOR', '1');
INSERT INTO MECANICOS (DNI, NOMBRE, PUESTO, PARCIAL) VALUES ('3333', 'PEPE', 'AMORTIGUACION', '0');
INSERT INTO MECANICOS (DNI, NOMBRE, PUESTO, PARCIAL) VALUES ('4444', 'LOLA', 'CHAPA', '0');
INSERT INTO MECANICOS (DNI, NOMBRE, PUESTO, PARCIAL) VALUES ('5555', 'LUISA', 'CHAPA', '0');
INSERT INTO MECANICOS (DNI, NOMBRE, PUESTO, PARCIAL) VALUES ('6666', 'EMILIO', 'AMORTIGUACION', '1');
INSERT INTO MECANICOS (DNI, NOMBRE, PUESTO, PARCIAL) VALUES ('7777', 'ANGEL', 'MOTOR', '1');
INSERT INTO MECANICOS (DNI, NOMBRE, PUESTO, PARCIAL) VALUES ('8888', 'JUANJO', 'CHAPA', '0');
INSERT INTO MECANICOS (DNI, NOMBRE, PUESTO, PARCIAL) VALUES ('9999', 'EFE', 'MOTOR', '0');


INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0001', 'M3020KY', '1111', '1', '2016-02-23');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0002', 'A3020KA', '2222 ', '1', '2017-03-29');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0003', 'B3020KB', '3333', '1', '2018-03-04');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0004', 'C3020KC', '3333', '1', '2019-06-12');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0005', 'D3020KD', '2222 ', '1', '2017-08-15');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0006', 'D3020KD', '4444', '1', '2019-10-19');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0007', 'M3020KY', '4444', '1', '2019-11-06');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0008', 'E3020KE', '5555', '1', '2017-09-20');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0009', 'C3020KC', '2222 ', '1', '2019-01-25');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0010', 'M3020KY', '6666', '1', '2017-04-13');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0011', 'A3020KA', '1111', '1', '2016-05-16');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0012', 'E3020KE', '5555', '1', '2016-03-17');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0013', 'E3020KE', '6666', '1', '2018-02-28');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0014', 'M3020KY', '7777', '1', '2019-06-03');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0015', 'B3020KB', '6666', '1', '2018-07-05');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0016', 'M3020KY', '7777', '1', '2019-11-24');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0017', 'M3020KY', '8888', '2', '2019-11-24');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0018', 'A3020KA', '8888', '4', '2019-11-24');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0019', 'A3020KA', '3333', '4', '2019-11-24');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0020', 'B3020KB', '5555', '4', '2019-11-24');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0021', 'B3020KB', '5555', '5', '2019-11-27');
INSERT INTO TRABAJOS (COD_TRABAJO, MAT, DNI, HORAS, FECHA_REP) VALUES ('0022', 'A3020KA', '9999', '4', '2019-11-28');

USE COCHES1;
-- OBTENER el maximo de horas en un coche renault
SELECT MAX(HORAS), MARCA FROM TRABAJOS T, COCHES C WHERE T.MAT = C.MAT AND MARCA = 'RENAULT';

SELECT HORAS, MARCA FROM TRABAJOS T, COCHES C WHERE MARCA = 'RENAULT' AND HORAS = (SELECT max(HORAS) FROM TRABAJOS T, COCHES C WHERE T.MAT = C.MAT AND MARCA = 'RENAULT');

SELECT T.MAT, MARCA, AN_FAB, COD_TRABAJO FROM COCHES C, TRABAJOS T, MECANICOS M WHERE (C.MAT = T.MAT AND T.DNI = M.DNI) AND M.PUESTO = 'AMORTIGUACION'  GROUP BY AN_FAB, COD_TRABAJO;

-- MECANICOS QUE HAN REPARADO MÁS DE DOS COCHES
SELECT DNI FROM TRABAJOS GROUP BY DNI HAVING COUNT(*)>2;
SELECT DNI FROM TRABAJOS GROUP BY DNI HAVING COUNT(*)>2; 
-- EL HAVING SIRVE PARA DENTRO DE UN GRUPO DESCARTAR ALGUNAS RESPUESTAS

SELECT T.MAT, MARCA, AN_FAB, COD_TRABAJO FROM COCHES C, TRABAJOS T, MECANICOS M WHERE (C.MAT = T.MAT AND T.DNI = M.DNI) AND (M.PUESTO = 'AMORTIGUACION' AND AN_FAB = 2017 ) GROUP BY AN_FAB, COD_TRABAJO;

-- Obtener los coches que NO son reparados por 'PEPE':
SELECT NOMBRE, MAT FROM MECANICOS M, TRABAJOS T WHERE M.DNI = T.DNI AND M.NOMBRE NOT IN (SELECT NOMBRE FROM MECANICOS WHERE NOMBRE = 'PEPE');

-- Obtener los mecánicos que no han reparado ningún coche RENAULT
SELECT NOMBRE, T.MAT, MARCA FROM MECANICOS M, TRABAJOS T, COCHES C  WHERE (M.DNI = T.DNI AND C.MAT = T.MAT) AND MARCA NOT IN (SELECT MARCA FROM COCHES WHERE MARCA ='PEUGEOT ');

-- Coches que no son fueron fabricados entre 1990 y 1999:
SELECT MAT, MARCA FROM COCHES WHERE AN_FAB NOT IN (SELECT AN_FAB FROM COCHES WHERE AN_FAB between 2016 AND 2018);

-- Marca y modelo de los coches de Antonio:

SELECT MARCA, MODELO, T.MAT FROM COCHES C, TRABAJOS T, MECANICOS M WHERE (C.MAT = T.MAT AND M.DNI = T.DNI) AND T.DNI = (SELECT DNI FROM MECANICOS WHERE NOMBRE = 'ANTONIO');

-- Obtener coches MAS ANTIGUOS DE CADA MARCA.

SELECT min(AN_FAB), MARCA, MAT FROM COCHES GROUP BY MARCA, MAT;

-- Obtener todos los trabajos incluyendo los datos del mecánico que realiza el trabajo
SELECT COD_TRABAJO, M.* FROM TRABAJOS T, MECANICOS M WHERE T.DNI = M.DNI GROUP BY COD_TRABAJO;

SELECT FECHA_REP, MAT, COD_TRABAJO, M.DNI, NOMBRE, PUESTO, PARCIAL FROM TRABAJOS T, MECANICOS M WHERE T.DNI = M.DNI GROUP BY COD_TRABAJO;

-- Obtener parejas de mecánicos del mismo puesto:

-- PREGUNTA- ESTA SELECT ES RARA Y A PARTE PORQUE FUNCIONA ASÍ? PORQUE NO PUEDO HACER GROUP BY DIRECTAMENTE DE PUESTO Y SE ME AGRUPA SOLA?

SELECT NOMBRE, DNI, PUESTO FROM MECANICOS GROUP BY PUESTO, DNI;
SELECT NOMBRE, PUESTO FROM MECANICOS GROUP BY PUESTO, NOMBRE;

-- numero de mecanicos por puesto
-- CREO QUE HACIENDO ESTO ENTENDÍ EL PROBLEMA ANTERIOR, AQUI LE DIGO QUE ME AGRUPE POR PUESTO Y ME CUENTE CUANTA GENTE HAY POR PUESTO. ANTES NO ES CAPAZ DE AGRUPARME POR PUESTO PORQUE NO SABE QUE DATOS TIENE QUE RELACIONAR
SELECT COUNT(*), PUESTO FROM MECANICOS GROUP BY PUESTO;

-- Obtener las marcas y modelos de los coches reparados de CHAPA:
SELECT MARCA, MODELO, COD_TRABAJO, PUESTO, T.DNI FROM COCHES C, TRABAJOS T, MECANICOS M 
WHERE (C.MAT = T.MAT AND M.DNI = T.DNI) AND M.PUESTO = 'CHAPA' GROUP BY PUESTO, COD_TRABAJO;

-- Obtener el total de horas trabajadas por los mecánicos de CHAPA:
SELECT SUM(HORAS), PUESTO FROM TRABAJOS T, MECANICOS M WHERE T.DNI = M.DNI AND PUESTO = 'CHAPA';
-- Obtener el total de horas trabajadas por PUESTO:
SELECT SUM(HORAS), PUESTO FROM TRABAJOS T, MECANICOS M WHERE T.DNI = M.DNI GROUP BY PUESTO;

-- Obtener la media de horas trabajadas con los coches RENAULT:
SELECT avg(HORAS), MARCA FROM COCHES C, TRABAJOS T WHERE C.MAT = T.MAT AND MARCA = 'RENAULT';

-- Obtener el precio del trabajo más caro:
SELECT MAX(HORAS) FROM TRABAJOS;
-- OBTENER el maximo de horas en un coche renault
SELECT MAX(HORAS), MARCA FROM TRABAJOS T, COCHES C WHERE MARCA = 'RENAULT' GROUP BY MARCA;
-- MAXIMO DE HORAS REALIZADAS POR LUISA EN UN COCHE RENAULT
-- PORQUE NO SALE!
SELECT MAX(HORAS) FROM TRABAJOS T, MECANICOS M, COCHES C WHERE (T.DNI=M.DNI AND C.MAT=T.MAT) AND (NOMBRE = 'LUISA' AND MARCA = 'RENAULT ');

SELECT MAX(HORAS) FROM TRABAJOS T, MECANICOS M, COCHES C WHERE (T.DNI = M.DNI AND C.MAT = T.MAT) AND (NOMBRE = 'PEPE' AND MARCA = 'RENAULT');

SELECT MAX(HORAS) AS MaxHoras
FROM TRABAJOS T, COCHES C, MECANICOS M
WHERE T.MAT = C.MAT
AND T.DNI = M.DNI
AND M.NOMBRE = 'LUISA'
AND C.MARCA = 'TOYOTA';

-- Obtener la mitad del número mínimo de horas trabajadas en un coche:
SELECT MIN(HORAS/2), FECHA_REP FROM TRABAJOS GROUP BY HORAS, FECHA_REP;

-- Obtener el numero total de horas por coche (matricula)  ordenadfos por matricula.
SELECT SUM(HORAS), MAT FROM TRABAJOS GROUP BY MAT;

-- Consultar el número de trabajos realizados a cada coche:
SELECT COUNT(*), MAT FROM TRABAJOS GROUP BY MAT; 

-- Consultar el número medio de horas trabajadas por puesto clasificados por tipo de contrato (atributo parcial):
SELECT AVG(HORAS), PUESTO, PARCIAL FROM TRABAJOS T, MECANICOS M WHERE M.DNI = T.DNI GROUP BY PARCIAL, PUESTO;

-- Obtener el número de trabajos realizados a grupos de coches con igual número de caracteres sumando la marca y el modelo:
SELECT COUNT(*), MARCA, MODELO FROM TRABAJOS T, COCHES C WHERE T.MAT = C.MAT GROUP BY MARCA, MODELO;

-- Obtener el número máximo de horas en total trabajadas sobre un coche:
SELECT MAX(HORAS), MARCA FROM TRABAJOS T, COCHES C WHERE C.MAT=T.MAT GROUP BY MARCA;

-- Obtener los mecánicos de CHAPA o AMORTIGUACION que han reparado más de dos coches:
SELECT T.DNI FROM TRABAJOS T, MECANICOS M WHERE T.DNI = M.DNI AND (PUESTO = 'CHAPA' OR PUESTO = 'AMORTIGUACION');

SELECT MECANICOS.NOMBRE, COUNT(*) AS TOTAL_REPARACIONES 
FROM MECANICOS, TRABAJOS, COCHES
WHERE MECANICOS.DNI = TRABAJOS.DNI
AND TRABAJOS.MAT = COCHES.MAT
AND MECANICOS.PUESTO IN ('CHAPA', 'AMORTIGUACION')
AND MECANICOS.DNI IN (
  SELECT TRABAJOS.DNI
  FROM TRABAJOS
  GROUP BY TRABAJOS.DNI
  HAVING COUNT(DISTINCT TRABAJOS.MAT) > 2
)
GROUP BY MECANICOS.NOMBRE;

-- Obtener los mecánicos que pertenecen al mismo puesto que EMILIO;
SELECT NOMBRE FROM MECANICOS WHERE PUESTO IN (SELECT PUESTO FROM MECANICOS WHERE NOMBRE = 'ANTONIO');

-- Obtener los coches reparados por algún mecánico de CHAPA:
SELECT MAT FROM TRABAJOS T, MECANICOS M WHERE T.DNI = M.DNI AND PUESTO ='CHAPA';

SELECT DISTINCT COCHES.MAT, COCHES.MARCA, COCHES.AN_FAB, COD_TRABAJO
FROM COCHES, TRABAJOS, MECANICOS
WHERE COCHES.MAT = TRABAJOS.MAT
AND TRABAJOS.DNI = MECANICOS.DNI
AND MECANICOS.PUESTO = 'CHAPA';
-- LA HICE BIEN, PERO HAY UN MECANICO LLAMADO LOLA QUE CUENTA COMO CHAPA PORQUE LO ESCRIBISTE MAL

-- Los mecánicos que reparan tres o más coches
SELECT M.DNI, NOMBRE FROM MECANICOS M, TRABAJOS T WHERE T.DNI = M.DNI AND 3 > (SELECT count(*) FROM TRABAJOS T GROUP BY DNI);

SELECT MECANICOS.NOMBRE, COUNT(DISTINCT TRABAJOS.MAT) AS TOTAL_COCHES_REPARADOS
FROM MECANICOS, TRABAJOS
WHERE MECANICOS.DNI = TRABAJOS.DNI
GROUP BY MECANICOS.NOMBRE
HAVING COUNT(DISTINCT TRABAJOS.MAT) >= 3;

-- Encontrar los mecánicos que han reparado todos los coches de alguna marca:
SELECT M.NOMBRE, C.MARCA FROM MECANICOS M, TRABAJOS T, COCHES C WHERE T.DNI = M.DNI AND C.MAT = T.MAT GROUP BY MARCA, NOMBRE;

-- Obtener el total de horas trabajadas por los mecánicos de chapa que tienen un contrato a tiempo parcial.

SELECT SUM(HORAS), NOMBRE FROM MECANICOS M, TRABAJOS T WHERE T.DNI = M.DNI AND (PARCIAL ='0' AND PUESTO = 'CHAPA')  GROUP BY NOMBRE; 
-- Obtener los mecánicos que no han reparado ningún coche RENAULT
SELECT DISTINCT NOMBRE, MARCA FROM MECANICOS M, TRABAJOS T, COCHES C WHERE (T.DNI = M.DNI AND C.MAT = T.MAT) AND MARCA NOT IN (SELECT MARCA FROM COCHES WHERE MARCA = 'TOYOTA'); 


SELECT COUNT(COD_TRABAJO), NOMBRE, PUESTO FROM MECANICOS M, TRABAJOS T WHERE T.DNI = M.DNI GROUP BY PUESTO, NOMBRE;

-- MECANICOS QUE HAN HECHO MAS DE 2 REPARACIONES
SELECT DNI, COUNT(*)  FROM TRABAJOS GROUP BY DNI HAVING COUNT(*)>2;

SELECT DNI, COUNT(COD_TRABAJO) FROM TRABAJOS GROUP BY DNI HAVING COUNT(COD_TRABAJO)>2;
